<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Smart Parking - Scan Plate</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <style>
        body {
            margin: 0;
            background: black;
            color: white;
            font-family: Arial, sans-serif;
            text-align: center;
        }
        video {
            width: 100vw;
            height: 100vh;
            object-fit: cover;
        }
        #status {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            padding: 10px 20px;
            border-radius: 10px;
        }
        .actionBtn {
            position: fixed;
            bottom: 20px;
            padding: 12px 22px;
            font-size: 16px;
            border: none;
            border-radius: 10px;
            background-color: #00AAFF;
            color: white;
        }
        #checkinBtn { left: 30%; transform: translateX(-50%); }
        #checkoutBtn { left: 70%; transform: translateX(-50%); }

        /* N√∫t c√¥ng c·ª• ·ªü g√≥c tr√™n ph·∫£i */
        .top-bar {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 100;
            display: flex;
            gap: 10px;
        }
        .top-btn {
            background: #FF9800;
            color: white;
            border: none;
            padding: 10px 0;
            width: 120px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
        }
        #toggleManualBtn { background: #FF9800; }
        #toggleQuickBtn { background: #9C27B0; }

        /* Quick List Styles */
        .quick-item {
            background: #333; padding: 10px; margin-bottom: 8px; border-radius: 5px;
            display: flex; justify-content: space-between; align-items: center;
            border: 1px solid #444;
        }
        .quick-info { text-align: left; }
        .quick-actions { display: flex; gap: 10px; }
        .btn-quick { padding: 8px 15px; border: none; border-radius: 5px; color: white; cursor: pointer; font-weight: bold; font-size: 14px; }
        .btn-in { background: #00AAFF; }
        .btn-out { background: #FF9800; }

        /* Form Overlay chung */
        .overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            display: none; /* ·∫®n m·∫∑c ƒë·ªãnh */
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .form-box {
            background: #222; padding: 25px; border-radius: 15px; width: 80%; max-width: 350px; 
            text-align: center; border: 1px solid #444;
        }
        .input-field { width: 90%; padding: 10px; margin-bottom: 15px; border-radius: 5px; border: none; }
        
        /* Hi·ªáu ·ª©ng qu√©t (Scanner Effect) */
        #scanOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 50; display: none;
        }
        .scan-line {
            position: absolute; width: 100%; height: 5px;
            background: var(--scan-color, #00FF00);
            box-shadow: 0 0 15px var(--scan-color, #00FF00), 0 0 30px var(--scan-color, #00FF00);
            animation: scanMove 1.5s infinite linear;
        }
        @keyframes scanMove {
            0% { top: 0%; opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { top: 100%; opacity: 0; }
        }
    </style>
</head>

<body>

<div class="top-bar">
    <button class="top-btn" onclick="window.location.href='admin/index.html'" style="background: #607D8B;">‚öôÔ∏è Qu·∫£n tr·ªã</button>
    <button id="toggleQuickBtn" class="top-btn" onclick="toggleQuickList()">‚ö° Ra/V√†o Nhanh</button>
    <button id="toggleManualBtn" class="top-btn" onclick="toggleManual()">‚úé Nh·∫≠p tay</button>
</div>

<video id="video" autoplay playsinline></video>
<canvas id="canvas" style="display:none;"></canvas>

<!-- Scanner Overlay -->
<div id="scanOverlay">
    <div class="scan-line"></div>
</div>

<div id="status">ƒêang kh·ªüi ƒë·ªông camera...</div>
<button id="checkinBtn" class="actionBtn">Check-in</button>
<button id="checkoutBtn" class="actionBtn">Check-out</button>

<!-- Form nh·∫≠p tay -->
<div id="manualOverlay" class="overlay">
    <div class="form-box">
        <h3 style="margin-top: 0; color: #FF9800;">Nh·∫≠p bi·ªÉn s·ªë</h3>
        <input type="text" id="manualInput" class="input-field" placeholder="VD: 30A-123.45" style="font-size: 18px; text-align: center; text-transform: uppercase;">
        <div style="display: flex; justify-content: space-around; gap: 10px;">
            <button onclick="sendManual(1)" style="flex: 1; background: #00AAFF; color: white; border: none; padding: 12px; border-radius: 8px; font-weight: bold;">V√†o</button>
            <button onclick="sendManual(0)" style="flex: 1; background: #FF9800; color: white; border: none; padding: 12px; border-radius: 8px; font-weight: bold;">Ra</button>
        </div>
        <button onclick="toggleManual()" style="margin-top: 20px; background: transparent; border: 1px solid #666; color: #aaa; padding: 8px 20px; border-radius: 20px;">ƒê√≥ng</button>
    </div>
</div>

<!-- Form Quick List Whitelist -->
<div id="quickListOverlay" class="overlay">
    <div class="form-box" style="max-width: 500px; width: 90%;">
        <h3 style="margin-top: 0; color: #9C27B0;">‚ö° Danh S√°ch Xe ∆Øu Ti√™n</h3>
        <input type="text" id="quickSearchInput" class="input-field" placeholder="üîç Nh·∫≠p s·ªë cu·ªëi bi·ªÉn s·ªë..." onkeyup="filterQuickList()" style="text-align: center; font-size: 16px; font-weight: bold;">
        <div id="quickListContainer" style="max-height: 400px; overflow-y: auto; margin-bottom: 20px;">
            <!-- Items will be loaded here -->
        </div>
        <button onclick="toggleQuickList()" style="background: transparent; border: 1px solid #666; color: #aaa; padding: 8px 20px; border-radius: 20px;">ƒê√≥ng</button>
    </div>
</div>

<!-- Modal X√°c Nh·∫≠n Xe V√£ng Lai -->
<div id="confirmOverlay" class="overlay">
    <div class="form-box" style="border: 2px solid #FF9800;">
        <h3 style="margin-top: 0; color: #FF9800;">‚ö†Ô∏è C·∫£nh B√°o Xe V√£ng Lai</h3>
        <p id="confirmMsg" style="font-size: 18px; font-weight: bold; margin: 20px 0;">Bi·ªÉn s·ªë: ---</p>
        <div style="display: flex; justify-content: space-around; gap: 10px;">
            <button onclick="handleGuestDecision(1)" style="flex: 1; background: #4CAF50; color: white; border: none; padding: 12px; border-radius: 8px; font-weight: bold;">‚úÖ Cho v√†o</button>
            <button onclick="handleGuestDecision(0)" style="flex: 1; background: #F44336; color: white; border: none; padding: 12px; border-radius: 8px; font-weight: bold;">‚ùå H·ªßy b·ªè</button>
        </div>
    </div>
</div>

<!-- Modal S·ª≠a Nhanh Sau Check-in -->
<div id="quickEditOverlay" class="overlay">
    <div class="form-box">
        <h3 style="margin-top: 0; color: #2196F3;">S·ª≠a Bi·ªÉn S·ªë</h3>
        <p style="color: #aaa; font-size: 12px;">C·∫≠p nh·∫≠t bi·ªÉn s·ªë cho l∆∞·ª£t xe v·ª´a v√†o</p>
        <input type="text" id="quickEditInput" class="input-field" style="font-size: 18px; text-align: center; text-transform: uppercase;">
        <button onclick="submitQuickEdit()" style="width:100%; background: #2196F3; color: white; border: none; padding: 12px; border-radius: 8px; font-weight: bold;">L∆∞u Thay ƒê·ªïi</button>
        <button onclick="closeQuickEdit()" style="margin-top: 10px; background: transparent; border: 1px solid #666; color: #aaa; padding: 8px 20px; border-radius: 20px;">H·ªßy</button>
    </div>
</div>

<script>
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const statusText = document.getElementById("status");
const checkinBtn = document.getElementById("checkinBtn");
const checkoutBtn = document.getElementById("checkoutBtn");
let cachedWhitelist = []; // L∆∞u cache danh s√°ch ƒë·ªÉ t√¨m ki·∫øm nhanh
let suggestedSearch = ""; // L∆∞u g·ª£i √Ω t√¨m ki·∫øm t·ª´ l·∫ßn qu√©t cu·ªëi
let currentBlob = null;   // L∆∞u ·∫£nh t·∫°m th·ªùi ƒë·ªÉ g·ª≠i l·∫°i n·∫øu x√°c nh·∫≠n
let currentPlate = "";    // L∆∞u bi·ªÉn s·ªë t·∫°m th·ªùi
let lastSessionId = null; // L∆∞u ID phi√™n l√†m vi·ªác g·∫ßn nh·∫•t ƒë·ªÉ s·ª≠a nhanh

// --- HELPER: Format bi·ªÉn s·ªë (VD: 30A12345 -> 30A-123.45) ---
function formatPlate(plate) {
    if (!plate) return "";
    const raw = plate.replace(/[^A-Z0-9]/g, ""); // Ch·ªâ l·∫•y ch·ªØ v√† s·ªë
    if (raw.length < 7) return plate; // Qu√° ng·∫Øn th√¨ gi·ªØ nguy√™n
    
    const prefix = raw.substring(0, 3);
    const suffix = raw.substring(3);
    
    // N·∫øu 5 s·ªë (VD: 12345) -> 123.45, N·∫øu 4 s·ªë (VD: 1234) -> 1234
    return suffix.length === 5 ? `${prefix}-${suffix.substring(0, 3)}.${suffix.substring(3)}` : `${prefix}-${suffix}`;
}

// üîß ƒê·ªäA CH·ªà BACKEND (s·ª≠a IP cho ƒë√∫ng)
// L∆∞u √Ω: Ph·∫£i d√πng https:// v√† ƒë√∫ng IP c·ªßa m√°y t√≠nh ch·∫°y backend
const BACKEND_URL = "https://192.168.43.82:8000/upload";

// 1Ô∏è‚É£ B·∫≠t camera sau
navigator.mediaDevices.getUserMedia({
    video: {
        facingMode: { ideal: "environment" }
    }
})
.then(stream => {
    video.srcObject = stream;
    statusText.innerText = "Camera ƒë√£ b·∫≠t ‚Äì b·∫•m 'Qu√©t' ƒë·ªÉ g·ª≠i ·∫£nh...";
})
.catch(err => {
    statusText.innerText = "Kh√¥ng b·∫≠t ƒë∆∞·ª£c camera!";
    console.error(err);
});

// 2Ô∏è‚É£ Khi b·∫•m n√∫t Check-in / Check-out ‚Äî g·ª≠i k√®m tr∆∞·ªùng `status` (1 = checkin, 0 = checkout)
async function sendCapture(status, manualPlate = null, confirmed = 0) {
    if (!video.videoWidth) {
        statusText.innerText = "Camera ch∆∞a s·∫µn s√†ng!";
        return;
    }

    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;

    const ctx = canvas.getContext("2d");
    ctx.drawImage(video, 0, 0);

    // N·∫øu l√† g·ª≠i l·∫°i (confirmed=1), d√πng blob c≈©. N·∫øu ch·ª•p m·ªõi, t·∫°o blob m·ªõi.
    const processBlob = (blob) => {
        if (!blob) return;
        currentBlob = blob; // L∆∞u l·∫°i ƒë·ªÉ d√πng n·∫øu c·∫ßn x√°c nh·∫≠n

        const formData = new FormData();
        formData.append("image", blob, "plate.jpg");
        formData.append("status", String(status));
        formData.append("confirmed", String(confirmed)); // G·ª≠i tr·∫°ng th√°i x√°c nh·∫≠n
        
        if (manualPlate) {
            formData.append("plate_number", manualPlate);
        }
        // N·∫øu ƒëang x√°c nh·∫≠n l·∫°i bi·ªÉn s·ªë c≈© (tr∆∞·ªùng h·ª£p AI ƒë·ªçc)
        if (confirmed === 1 && currentPlate && !manualPlate) formData.append("plate_number", currentPlate);

        statusText.innerText = "ƒêang g·ª≠i ·∫£nh...";
        
        startScanEffect(status); // B·∫Øt ƒë·∫ßu hi·ªáu ·ª©ng qu√©t

        fetch(BACKEND_URL, {
            method: "POST",
            body: formData
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                // --- LOGIC G·ª¢I √ù T√åM KI·∫æM ---
                // N·∫øu qu√©t ƒë∆∞·ª£c bi·ªÉn s·ªë, l·∫•y 4 k√Ω t·ª± cu·ªëi ƒë·ªÉ l√†m g·ª£i √Ω cho Quick List
                if (data.plate_number) {
                    // X√≥a k√Ω t·ª± ƒë·∫∑c bi·ªát, ch·ªâ l·∫•y ch·ªØ s·ªë
                    const cleanPlate = data.plate_number.replace(/[^a-zA-Z0-9]/g, "");
                    suggestedSearch = cleanPlate.length > 4 ? cleanPlate.slice(-4) : cleanPlate;
                }

                lastSessionId = data.id; // L∆∞u ID ƒë·ªÉ d√πng cho ch·ª©c nƒÉng s·ª≠a nhanh

                statusText.style.backgroundColor = "rgba(0, 0, 0, 0.7)"; // M√†u ƒëen (b√¨nh th∆∞·ªùng)
                if (status === 1) {
                    // Check-in: Hi·ªÉn th·ªã th√™m n√∫t S·ª≠a
                    const plateDisplay = data.plate_number || 'Kh√¥ng r√µ';
                    statusText.innerHTML = `‚úÖ ${data.message}<br>üöó Bi·ªÉn s·ªë: <b>${plateDisplay}</b> <button onclick="openQuickEdit('${plateDisplay}')" style="background:#FF9800; border:none; color:white; padding:4px 8px; border-radius:4px; cursor:pointer; font-weight:bold; margin-left:5px;">‚úèÔ∏è S·ª≠a</button>`;
                } else {
                    // Check-out
                    const feeStr = data.fee ? data.fee.toLocaleString('vi-VN') : "0";
                    statusText.innerText = `‚úÖ ${data.message}\nüöó Bi·ªÉn s·ªë: ${data.plate_number || 'Kh√¥ng r√µ'}\nüí∞ Ph√≠: ${feeStr} VNƒê`;
                }
            } else if (data.need_confirmation) {
                // --- TR∆Ø·ªúNG H·ª¢P XE V√ÉNG LAI C·∫¶N X√ÅC NH·∫¨N ---
                statusText.style.backgroundColor = "rgba(255, 152, 0, 0.8)"; // M√†u cam
                statusText.innerText = "‚ö†Ô∏è " + data.message;
                currentPlate = data.plate_number; // L∆∞u bi·ªÉn s·ªë BE ƒë·ªçc ƒë∆∞·ª£c
                showConfirmModal(data.plate_number);
                
            } else {
                statusText.style.backgroundColor = "rgba(255, 0, 0, 0.8)"; // M√†u ƒë·ªè (l·ªói/c·∫£nh b√°o)
                statusText.innerText = data.message || "‚ö†Ô∏è L·ªói t·ª´ Server";
            }
        })
        .catch(err => {
            statusText.innerText = "‚ùå Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c BE";
            console.error(err);
        })
        .finally(() => {
            stopScanEffect(); // T·∫Øt hi·ªáu ·ª©ng
        });

    };

    if (confirmed === 1 && currentBlob) {
        processBlob(currentBlob); // D√πng l·∫°i ·∫£nh c≈©
    } else {
        canvas.toBlob(processBlob, "image/jpeg", 0.8); // Ch·ª•p ·∫£nh m·ªõi
    }
}

checkinBtn.addEventListener('click', () => sendCapture(1));
checkoutBtn.addEventListener('click', () => sendCapture(0));

// --- Logic cho Form nh·∫≠p tay ---
function toggleManual() {
    const overlay = document.getElementById("manualOverlay");
    overlay.style.display = overlay.style.display === "flex" ? "none" : "flex";
    if (overlay.style.display === "flex") {
        document.getElementById("manualInput").focus();
    }
}

function sendManual(status) {
    const plate = document.getElementById("manualInput").value.trim();
    if (!plate) {
        alert("Vui l√≤ng nh·∫≠p bi·ªÉn s·ªë!");
        return;
    }
    toggleManual(); // ƒê√≥ng form
    sendCapture(status, plate); // G·ª≠i k√®m bi·ªÉn s·ªë nh·∫≠p tay
}

// --- Logic cho Quick List Whitelist ---
function toggleQuickList() {
    const overlay = document.getElementById("quickListOverlay");
    overlay.style.display = overlay.style.display === "flex" ? "none" : "flex";
    if (overlay.style.display === "flex") {
        // Khi m·ªü, t·ª± ƒë·ªông ƒëi·ªÅn g·ª£i √Ω t√¨m ki·∫øm (n·∫øu c√≥)
        const searchInput = document.getElementById("quickSearchInput");
        searchInput.value = suggestedSearch;
        searchInput.focus();
        
        loadQuickWhitelist();
    }
}

function loadQuickWhitelist() {
    const container = document.getElementById("quickListContainer");
    container.innerHTML = "<div style='text-align:center; color:#777'>ƒêang t·∫£i...</div>";
    
    const url = BACKEND_URL.replace("/upload", "/api/whitelist");
    
    fetch(url)
    .then(res => res.json())
    .then(data => {
        container.innerHTML = "";
        cachedWhitelist = data; // L∆∞u v√†o bi·∫øn to√†n c·ª•c
        filterQuickList(); // G·ªçi h√†m hi·ªÉn th·ªã (c√≥ √°p d·ª•ng l·ªçc)
    })
    .catch(err => {
        container.innerHTML = "<div style='text-align:center; color:red'>L·ªói k·∫øt n·ªëi</div>";
        console.error(err);
    });
}

function filterQuickList() {
    const container = document.getElementById("quickListContainer");
    const query = document.getElementById("quickSearchInput").value.toUpperCase().trim();
    
    if (cachedWhitelist.length === 0) {
        container.innerHTML = "<div style='text-align:center; color:#777'>Danh s√°ch tr·ªëng</div>";
        return;
    }

    // L·ªçc danh s√°ch
    let filtered = cachedWhitelist.filter(item => {
        // Chu·∫©n h√≥a bi·ªÉn s·ªë trong DB ƒë·ªÉ so s√°nh (b·ªè d·∫•u ch·∫•m, g·∫°ch)
        const rawPlate = item.plate_number.replace(/[^A-Z0-9]/g, "");
        return rawPlate.includes(query);
    });

    // S·∫Øp x·∫øp: ∆Øu ti√™n bi·ªÉn s·ªë c√≥ ƒêU√îI kh·ªõp v·ªõi t·ª´ kh√≥a (t√¨m theo s·ªë cu·ªëi)
    filtered.sort((a, b) => {
        const rawA = a.plate_number.replace(/[^A-Z0-9]/g, "");
        const rawB = b.plate_number.replace(/[^A-Z0-9]/g, "");
        const endsWithA = rawA.endsWith(query);
        const endsWithB = rawB.endsWith(query);
        if (endsWithA && !endsWithB) return -1; // A l√™n ƒë·∫ßu
        if (!endsWithA && endsWithB) return 1;  // B l√™n ƒë·∫ßu
        return 0;
    });

    container.innerHTML = "";
    if (filtered.length === 0) {
        container.innerHTML = "<div style='text-align:center; color:#777'>Kh√¥ng t√¨m th·∫•y xe ph√π h·ª£p</div>";
        return;
    }

    filtered.forEach(item => {
        const div = document.createElement("div");
        const formattedPlate = formatPlate(item.plate_number); // Format tr∆∞·ªõc khi hi·ªÉn th·ªã v√† d√πng
        div.className = "quick-item";
        div.innerHTML = `
            <div class="quick-info">
                <div style="font-weight:bold; color:#fff">${formattedPlate}</div>
                <div style="color:#aaa; font-size:12px;">${item.owner_name || '---'}</div>
            </div>
            <div class="quick-actions">
                <button class="btn-quick btn-in" onclick="handleQuickAction('${formattedPlate}', 1)">V√†o</button>
                <button class="btn-quick btn-out" onclick="handleQuickAction('${formattedPlate}', 0)">Ra</button>
            </div>
        `;
        container.appendChild(div);
    });
}

function handleQuickAction(plate, status) {
    toggleQuickList(); // ƒê√≥ng danh s√°ch
    sendCapture(status, plate); // G·ªçi h√†m g·ª≠i ·∫£nh k√®m bi·ªÉn s·ªë
}

// --- Logic X√°c Nh·∫≠n Xe V√£ng Lai ---
function showConfirmModal(plate) {
    const overlay = document.getElementById("confirmOverlay");
    document.getElementById("confirmMsg").innerText = `Bi·ªÉn s·ªë: ${formatPlate(plate)}`;
    overlay.style.display = "flex";
}

function handleGuestDecision(decision) {
    document.getElementById("confirmOverlay").style.display = "none";
    if (decision === 1) {
        // Ng∆∞·ªùi d√πng ch·ªçn "Cho v√†o" -> G·ª≠i l·∫°i v·ªõi confirmed = 1
        sendCapture(1, null, 1);
    } else {
        // Ng∆∞·ªùi d√πng ch·ªçn "H·ªßy" -> X√≥a blob t·∫°m
        statusText.innerText = "‚ùå ƒê√£ h·ªßy check-in xe v√£ng lai.";
        currentBlob = null;
    }
}

// --- Logic S·ª≠a Nhanh (Quick Edit) ---
function openQuickEdit(currentPlate) {
    document.getElementById("quickEditOverlay").style.display = "flex";
    const input = document.getElementById("quickEditInput");
    // N·∫øu bi·ªÉn s·ªë l√† 'Kh√¥ng r√µ' th√¨ ƒë·ªÉ tr·ªëng ƒë·ªÉ nh·∫≠p cho nhanh
    input.value = (currentPlate && currentPlate !== 'Kh√¥ng r√µ') ? currentPlate : "";
    input.focus();
}

function closeQuickEdit() {
    document.getElementById("quickEditOverlay").style.display = "none";
}

function submitQuickEdit() {
    const newPlate = document.getElementById("quickEditInput").value.trim().toUpperCase();
    if (!newPlate) return alert("Vui l√≤ng nh·∫≠p bi·ªÉn s·ªë!");
    
    if (!lastSessionId) return alert("Kh√¥ng t√¨m th·∫•y phi√™n l√†m vi·ªác ƒë·ªÉ s·ª≠a!");

    const formData = new FormData();
    formData.append("plate_number", newPlate);
    formData.append("status", "PARKING"); // M·∫∑c ƒë·ªãnh l√† ƒëang g·ª≠i v√¨ ƒë√¢y l√† s·ª≠a sau check-in
    formData.append("fee", "0");

    // G·ªçi API PUT /api/sessions/{id}
    const apiUrl = BACKEND_URL.replace("/upload", `/api/sessions/${lastSessionId}`);

    fetch(apiUrl, { method: "PUT", body: formData })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            statusText.innerHTML = `‚úÖ ƒê√£ c·∫≠p nh·∫≠t<br>üöó Bi·ªÉn s·ªë: <b>${newPlate}</b>`;
            closeQuickEdit();
        } else {
            alert("L·ªói: " + data.message);
        }
    })
    .catch(err => alert("L·ªói k·∫øt n·ªëi!"));
}

// --- Logic Hi·ªáu ·ª©ng qu√©t ---
function startScanEffect(status) {
    const overlay = document.getElementById("scanOverlay");
    const line = document.querySelector(".scan-line");
    // 1 = Check-in (Xanh l√°), 0 = Check-out (Cam)
    const color = status === 1 ? "#00FF00" : "#FF9800";
    line.style.setProperty("--scan-color", color);
    overlay.style.display = "block";
}

function stopScanEffect() {
    document.getElementById("scanOverlay").style.display = "none";
}

</script>

</body>
</html>
