<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>æ™ºæ…§åœè»Š - è»Šç‰Œæƒæ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <style>
        body {
            margin: 0;
            background: black;
            color: white;
            font-family: Arial, sans-serif;
            text-align: center;
        }
        video {
            width: 100vw;
            height: 100vh;
            object-fit: cover;
        }
        #status {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            padding: 10px 20px;
            border-radius: 10px;
        }
        .actionBtn {
            position: fixed;
            bottom: 20px;
            padding: 12px 22px;
            font-size: 16px;
            border: none;
            border-radius: 10px;
            background-color: #00AAFF;
            color: white;
        }
        #checkinBtn { left: 30%; transform: translateX(-50%); }
        #checkoutBtn { left: 70%; transform: translateX(-50%); }

        /* NÃºt cÃ´ng cá»¥ á»Ÿ gÃ³c trÃªn pháº£i */
        .top-bar {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 100;
            display: flex;
            gap: 10px;
        }
        .top-btn {
            background: #FF9800;
            color: white;
            border: none;
            padding: 10px 0;
            width: 120px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
        }
        #toggleManualBtn { background: #FF9800; }
        #toggleQuickBtn { background: #9C27B0; }

        /* Quick List Styles */
        .quick-item {
            background: #333; padding: 10px; margin-bottom: 8px; border-radius: 5px;
            display: flex; justify-content: space-between; align-items: center;
            border: 1px solid #444;
        }
        .quick-info { text-align: left; }
        .quick-actions { display: flex; gap: 10px; }
        .btn-quick { padding: 8px 15px; border: none; border-radius: 5px; color: white; cursor: pointer; font-weight: bold; font-size: 14px; }
        .btn-in { background: #00AAFF; }
        .btn-out { background: #FF9800; }

        /* Form Overlay chung */
        .overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            display: none; /* áº¨n máº·c Ä‘á»‹nh */
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .form-box {
            background: #222; padding: 25px; border-radius: 15px; width: 80%; max-width: 350px; 
            text-align: center; border: 1px solid #444;
        }
        .input-field { width: 90%; padding: 10px; margin-bottom: 15px; border-radius: 5px; border: none; }
        
        /* Hiá»‡u á»©ng quÃ©t (Scanner Effect) */
        #scanOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 50; display: none;
        }
        .scan-line {
            position: absolute; width: 100%; height: 5px;
            background: var(--scan-color, #00FF00);
            box-shadow: 0 0 15px var(--scan-color, #00FF00), 0 0 30px var(--scan-color, #00FF00);
            animation: scanMove 1.5s infinite linear;
        }
        @keyframes scanMove {
            0% { top: 0%; opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { top: 100%; opacity: 0; }
        }
    </style>
</head>

<body>

<div class="top-bar">
    <button class="top-btn" onclick="window.location.href='admin/index.html'" style="background: #607D8B;">âš™ï¸ ç®¡ç†</button>
    <button id="toggleQuickBtn" class="top-btn" onclick="toggleQuickList()">âš¡ å¿«é€Ÿé€²å‡º</button>
    <button id="toggleManualBtn" class="top-btn" onclick="toggleManual()">âœ æ‰‹å‹•è¼¸å…¥</button>
</div>

<video id="video" autoplay playsinline></video>
<canvas id="canvas" style="display:none;"></canvas>

<!-- Scanner Overlay -->
<div id="scanOverlay">
    <div class="scan-line"></div>
</div>

<div id="status">æ­£åœ¨å•Ÿå‹•ç›¸æ©Ÿ...</div>
<button id="checkinBtn" class="actionBtn">å…¥å ´</button>
<button id="checkoutBtn" class="actionBtn">å‡ºå ´</button>

<!-- Form nháº­p tay -->
<div id="manualOverlay" class="overlay">
    <div class="form-box">
        <h3 style="margin-top: 0; color: #FF9800;">è¼¸å…¥è»Šç‰Œ</h3>
        <input type="text" id="manualInput" class="input-field" placeholder="ä¾‹å¦‚: 30A-123.45" style="font-size: 18px; text-align: center; text-transform: uppercase;">
        <div style="display: flex; justify-content: space-around; gap: 10px;">
            <button onclick="sendManual(1)" style="flex: 1; background: #00AAFF; color: white; border: none; padding: 12px; border-radius: 8px; font-weight: bold;">é€²</button>
            <button onclick="sendManual(0)" style="flex: 1; background: #FF9800; color: white; border: none; padding: 12px; border-radius: 8px; font-weight: bold;">å‡º</button>
        </div>
        <button onclick="toggleManual()" style="margin-top: 20px; background: transparent; border: 1px solid #666; color: #aaa; padding: 8px 20px; border-radius: 20px;">é—œé–‰</button>
    </div>
</div>

<!-- Form Quick List Whitelist -->
<div id="quickListOverlay" class="overlay">
    <div class="form-box" style="max-width: 500px; width: 90%;">
        <h3 style="margin-top: 0; color: #9C27B0;">âš¡ å„ªå…ˆè»Šè¼›åå–®</h3>
        <input type="text" id="quickSearchInput" class="input-field" placeholder="ğŸ” è¼¸å…¥è»Šç‰Œå°¾è™Ÿ..." onkeyup="filterQuickList()" style="text-align: center; font-size: 16px; font-weight: bold;">
        <div id="quickListContainer" style="max-height: 400px; overflow-y: auto; margin-bottom: 20px;">
            <!-- Items will be loaded here -->
        </div>
        <button onclick="toggleQuickList()" style="background: transparent; border: 1px solid #666; color: #aaa; padding: 8px 20px; border-radius: 20px;">é—œé–‰</button>
    </div>
</div>

<!-- Modal XÃ¡c Nháº­n Xe VÃ£ng Lai -->
<div id="confirmOverlay" class="overlay">
    <div class="form-box" style="border: 2px solid #FF9800;">
        <h3 style="margin-top: 0; color: #FF9800;">âš ï¸ è¨ªå®¢è»Šè¼›è­¦å‘Š</h3>
        <p id="confirmMsg" style="font-size: 18px; font-weight: bold; margin: 20px 0;">è»Šç‰Œ: ---</p>
        <div style="display: flex; justify-content: space-around; gap: 10px;">
            <button onclick="handleGuestDecision(1)" style="flex: 1; background: #4CAF50; color: white; border: none; padding: 12px; border-radius: 8px; font-weight: bold;">âœ… å…è¨±é€²å…¥</button>
            <button onclick="handleGuestDecision(0)" style="flex: 1; background: #F44336; color: white; border: none; padding: 12px; border-radius: 8px; font-weight: bold;">âŒ å–æ¶ˆ</button>
        </div>
    </div>
</div>

<!-- Modal Sá»­a Nhanh Sau Check-in -->
<div id="quickEditOverlay" class="overlay">
    <div class="form-box">
        <h3 style="margin-top: 0; color: #2196F3;">ä¿®æ”¹è»Šç‰Œ</h3>
        <p style="color: #aaa; font-size: 12px;">æ›´æ–°å‰›å…¥å ´è»Šè¼›çš„è»Šç‰Œ</p>
        <input type="text" id="quickEditInput" class="input-field" style="font-size: 18px; text-align: center; text-transform: uppercase;">
        <button onclick="submitQuickEdit()" style="width:100%; background: #2196F3; color: white; border: none; padding: 12px; border-radius: 8px; font-weight: bold;">å„²å­˜è®Šæ›´</button>
        <button onclick="closeQuickEdit()" style="margin-top: 10px; background: transparent; border: 1px solid #666; color: #aaa; padding: 8px 20px; border-radius: 20px;">å–æ¶ˆ</button>
    </div>
</div>

<script>
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const statusText = document.getElementById("status");
const checkinBtn = document.getElementById("checkinBtn");
const checkoutBtn = document.getElementById("checkoutBtn");
let cachedWhitelist = []; // LÆ°u cache danh sÃ¡ch Ä‘á»ƒ tÃ¬m kiáº¿m nhanh
let suggestedSearch = ""; // LÆ°u gá»£i Ã½ tÃ¬m kiáº¿m tá»« láº§n quÃ©t cuá»‘i
let currentBlob = null;   // LÆ°u áº£nh táº¡m thá»i Ä‘á»ƒ gá»­i láº¡i náº¿u xÃ¡c nháº­n
let currentPlate = "";    // LÆ°u biá»ƒn sá»‘ táº¡m thá»i
let lastSessionId = null; // LÆ°u ID phiÃªn lÃ m viá»‡c gáº§n nháº¥t Ä‘á»ƒ sá»­a nhanh

// --- HELPER: Format biá»ƒn sá»‘ (VD: 30A12345 -> 30A-123.45) ---
function formatPlate(plate) {
    if (!plate) return "";
    const raw = plate.replace(/[^A-Z0-9]/g, ""); // Chá»‰ láº¥y chá»¯ vÃ  sá»‘
    if (raw.length < 7) return plate; // QuÃ¡ ngáº¯n thÃ¬ giá»¯ nguyÃªn
    
    const prefix = raw.substring(0, 3);
    const suffix = raw.substring(3);
    
    // Náº¿u 5 sá»‘ (VD: 12345) -> 123.45, Náº¿u 4 sá»‘ (VD: 1234) -> 1234
    return suffix.length === 5 ? `${prefix}-${suffix.substring(0, 3)}.${suffix.substring(3)}` : `${prefix}-${suffix}`;
}

// ğŸ”§ Äá»ŠA CHá»ˆ BACKEND (sá»­a IP cho Ä‘Ãºng)
// LÆ°u Ã½: Pháº£i dÃ¹ng https:// vÃ  Ä‘Ãºng IP cá»§a mÃ¡y tÃ­nh cháº¡y backend
const BACKEND_URL = "https://192.168.43.82:8000/upload";

// 1ï¸âƒ£ Báº­t camera sau
navigator.mediaDevices.getUserMedia({
    video: {
        facingMode: { ideal: "environment" }
    }
})
.then(stream => {
    video.srcObject = stream;
    statusText.innerText = "ç›¸æ©Ÿå·²é–‹å•Ÿ â€“ æŒ‰ä¸‹æŒ‰éˆ•ç™¼é€ç…§ç‰‡...";
})
.catch(err => {
    statusText.innerText = "ç›¸æ©Ÿå°šæœªæº–å‚™å¥½ï¼";
    console.error(err);
});

// 2ï¸âƒ£ Khi báº¥m nÃºt Check-in / Check-out â€” gá»­i kÃ¨m trÆ°á»ng `status` (1 = checkin, 0 = checkout)
async function sendCapture(status, manualPlate = null, confirmed = 0) {
    if (!video.videoWidth) {
        statusText.innerText = "ç›¸æ©Ÿå°šæœªæº–å‚™å¥½ï¼";
        return;
    }

    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;

    const ctx = canvas.getContext("2d");
    ctx.drawImage(video, 0, 0);

    // Náº¿u lÃ  gá»­i láº¡i (confirmed=1), dÃ¹ng blob cÅ©. Náº¿u chá»¥p má»›i, táº¡o blob má»›i.
    const processBlob = (blob) => {
        if (!blob) return;
        currentBlob = blob; // LÆ°u láº¡i Ä‘á»ƒ dÃ¹ng náº¿u cáº§n xÃ¡c nháº­n

        const formData = new FormData();
        formData.append("image", blob, "plate.jpg");
        formData.append("status", String(status));
        formData.append("confirmed", String(confirmed)); // Gá»­i tráº¡ng thÃ¡i xÃ¡c nháº­n
        
        if (manualPlate) {
            formData.append("plate_number", manualPlate);
        }
        // Náº¿u Ä‘ang xÃ¡c nháº­n láº¡i biá»ƒn sá»‘ cÅ© (trÆ°á»ng há»£p AI Ä‘á»c)
        if (confirmed === 1 && currentPlate && !manualPlate) formData.append("plate_number", currentPlate);

        statusText.innerText = "æ­£åœ¨ç™¼é€ç…§ç‰‡...";
        
        startScanEffect(status); // Báº¯t Ä‘áº§u hiá»‡u á»©ng quÃ©t

        fetch(BACKEND_URL, {
            method: "POST",
            body: formData
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                // --- LOGIC Gá»¢I Ã TÃŒM KIáº¾M ---
                // Náº¿u quÃ©t Ä‘Æ°á»£c biá»ƒn sá»‘, láº¥y 4 kÃ½ tá»± cuá»‘i Ä‘á»ƒ lÃ m gá»£i Ã½ cho Quick List
                if (data.plate_number) {
                    // XÃ³a kÃ½ tá»± Ä‘áº·c biá»‡t, chá»‰ láº¥y chá»¯ sá»‘
                    const cleanPlate = data.plate_number.replace(/[^a-zA-Z0-9]/g, "");
                    suggestedSearch = cleanPlate.length > 4 ? cleanPlate.slice(-4) : cleanPlate;
                }

                lastSessionId = data.id; // LÆ°u ID Ä‘á»ƒ dÃ¹ng cho chá»©c nÄƒng sá»­a nhanh

                statusText.style.backgroundColor = "rgba(0, 0, 0, 0.7)"; // MÃ u Ä‘en (bÃ¬nh thÆ°á»ng)
                if (status === 1) {
                    // Check-in: Hiá»ƒn thá»‹ thÃªm nÃºt Sá»­a
                    const plateDisplay = data.plate_number || 'æœªçŸ¥';
                    statusText.innerHTML = `âœ… ${data.message}<br>ğŸš— è»Šç‰Œ: <b>${plateDisplay}</b> <button onclick="openQuickEdit('${plateDisplay}')" style="background:#FF9800; border:none; color:white; padding:4px 8px; border-radius:4px; cursor:pointer; font-weight:bold; margin-left:5px;">âœï¸ ä¿®æ”¹</button>`;
                } else {
                    // Check-out
                    const feeStr = data.fee ? data.fee.toLocaleString('vi-VN') : "0";
                    statusText.innerText = `âœ… ${data.message}\nğŸš— è»Šç‰Œ: ${data.plate_number || 'æœªçŸ¥'}\nğŸ’° è²»ç”¨: ${feeStr} VNÄ`;
                }
            } else if (data.need_confirmation) {
                // --- TRÆ¯á»œNG Há»¢P XE VÃƒNG LAI Cáº¦N XÃC NHáº¬N ---
                statusText.style.backgroundColor = "rgba(255, 152, 0, 0.8)"; // MÃ u cam
                statusText.innerText = "âš ï¸ " + data.message;
                currentPlate = data.plate_number; // LÆ°u biá»ƒn sá»‘ BE Ä‘á»c Ä‘Æ°á»£c
                showConfirmModal(data.plate_number);
                
            } else {
                statusText.style.backgroundColor = "rgba(255, 0, 0, 0.8)"; // MÃ u Ä‘á» (lá»—i/cáº£nh bÃ¡o)
                statusText.innerText = data.message || "âš ï¸ Lá»—i tá»« Server";
            }
        })
        .catch(err => {
            statusText.innerText = "ç„¡æ³•é€£æ¥å¾Œç«¯";
            console.error(err);
        })
        .finally(() => {
            stopScanEffect(); // Táº¯t hiá»‡u á»©ng
        });

    };

    if (confirmed === 1 && currentBlob) {
        processBlob(currentBlob); // DÃ¹ng láº¡i áº£nh cÅ©
    } else {
        canvas.toBlob(processBlob, "image/jpeg", 0.8); // Chá»¥p áº£nh má»›i
    }
}

checkinBtn.addEventListener('click', () => sendCapture(1));
checkoutBtn.addEventListener('click', () => sendCapture(0));

// --- Logic cho Form nháº­p tay ---
function toggleManual() {
    const overlay = document.getElementById("manualOverlay");
    overlay.style.display = overlay.style.display === "flex" ? "none" : "flex";
    if (overlay.style.display === "flex") {
        document.getElementById("manualInput").focus();
    }
}

function sendManual(status) {
    const plate = document.getElementById("manualInput").value.trim();
    if (!plate) {
        alert("è«‹è¼¸å…¥è»Šç‰Œï¼");
        return;
    }
    toggleManual(); // ÄÃ³ng form
    sendCapture(status, plate); // Gá»­i kÃ¨m biá»ƒn sá»‘ nháº­p tay
}

// --- Logic cho Quick List Whitelist ---
function toggleQuickList() {
    const overlay = document.getElementById("quickListOverlay");
    overlay.style.display = overlay.style.display === "flex" ? "none" : "flex";
    if (overlay.style.display === "flex") {
        // Khi má»Ÿ, tá»± Ä‘á»™ng Ä‘iá»n gá»£i Ã½ tÃ¬m kiáº¿m (náº¿u cÃ³)
        const searchInput = document.getElementById("quickSearchInput");
        searchInput.value = suggestedSearch;
        searchInput.focus();
        
        loadQuickWhitelist();
    }
}

function loadQuickWhitelist() {
    const container = document.getElementById("quickListContainer");
    container.innerHTML = "<div style='text-align:center; color:#777'>æ­£åœ¨è¼‰å…¥...</div>";
    
    const url = BACKEND_URL.replace("/upload", "/api/whitelist");
    
    fetch(url)
    .then(res => res.json())
    .then(data => {
        container.innerHTML = "";
        cachedWhitelist = data; // LÆ°u vÃ o biáº¿n toÃ n cá»¥c
        filterQuickList(); // Gá»i hÃ m hiá»ƒn thá»‹ (cÃ³ Ã¡p dá»¥ng lá»c)
    })
    .catch(err => {
        container.innerHTML = "<div style='text-align:center; color:red'>é€£ç·šéŒ¯èª¤</div>";
        console.error(err);
    });
}

function filterQuickList() {
    const container = document.getElementById("quickListContainer");
    const query = document.getElementById("quickSearchInput").value.toUpperCase().trim();
    
    if (cachedWhitelist.length === 0) {
        container.innerHTML = "<div style='text-align:center; color:#777'>æ¸…å–®ç‚ºç©º</div>";
        return;
    }

    // Lá»c danh sÃ¡ch
    let filtered = cachedWhitelist.filter(item => {
        // Chuáº©n hÃ³a biá»ƒn sá»‘ trong DB Ä‘á»ƒ so sÃ¡nh (bá» dáº¥u cháº¥m, gáº¡ch)
        const rawPlate = item.plate_number.replace(/[^A-Z0-9]/g, "");
        return rawPlate.includes(query);
    });

    // Sáº¯p xáº¿p: Æ¯u tiÃªn biá»ƒn sá»‘ cÃ³ ÄUÃ”I khá»›p vá»›i tá»« khÃ³a (tÃ¬m theo sá»‘ cuá»‘i)
    filtered.sort((a, b) => {
        const rawA = a.plate_number.replace(/[^A-Z0-9]/g, "");
        const rawB = b.plate_number.replace(/[^A-Z0-9]/g, "");
        const endsWithA = rawA.endsWith(query);
        const endsWithB = rawB.endsWith(query);
        if (endsWithA && !endsWithB) return -1; // A lÃªn Ä‘áº§u
        if (!endsWithA && endsWithB) return 1;  // B lÃªn Ä‘áº§u
        return 0;
    });

    container.innerHTML = "";
    if (filtered.length === 0) {
        container.innerHTML = "<div style='text-align:center; color:#777'>æ‰¾ä¸åˆ°ç›¸ç¬¦è»Šè¼›</div>";
        return;
    }

    filtered.forEach(item => {
        const div = document.createElement("div");
        const formattedPlate = formatPlate(item.plate_number); // Format trÆ°á»›c khi hiá»ƒn thá»‹ vÃ  dÃ¹ng
        div.className = "quick-item";
        div.innerHTML = `
            <div class="quick-info">
                <div style="font-weight:bold; color:#fff">${formattedPlate}</div>
                <div style="color:#aaa; font-size:12px;">${item.owner_name || '---'}</div>
            </div>
            <div class="quick-actions">
                <button class="btn-quick btn-in" onclick="handleQuickAction('${formattedPlate}', 1)">é€²</button>
                <button class="btn-quick btn-out" onclick="handleQuickAction('${formattedPlate}', 0)">å‡º</button>
            </div>
        `;
        container.appendChild(div);
    });
}

function handleQuickAction(plate, status) {
    toggleQuickList(); // ÄÃ³ng danh sÃ¡ch
    sendCapture(status, plate); // Gá»i hÃ m gá»­i áº£nh kÃ¨m biá»ƒn sá»‘
}

// --- Logic XÃ¡c Nháº­n Xe VÃ£ng Lai ---
function showConfirmModal(plate) {
    const overlay = document.getElementById("confirmOverlay");
    document.getElementById("confirmMsg").innerText = `è»Šç‰Œ: ${formatPlate(plate)}`;
    overlay.style.display = "flex";
}

function handleGuestDecision(decision) {
    document.getElementById("confirmOverlay").style.display = "none";
    if (decision === 1) {
        // NgÆ°á»i dÃ¹ng chá»n "Cho vÃ o" -> Gá»­i láº¡i vá»›i confirmed = 1
        sendCapture(1, null, 1);
    } else {
        // NgÆ°á»i dÃ¹ng chá»n "Há»§y" -> XÃ³a blob táº¡m
        statusText.innerText = "å·²å–æ¶ˆè¨ªå®¢è»Šè¼›å…¥å ´ã€‚";
        currentBlob = null;
    }
}

// --- Logic Sá»­a Nhanh (Quick Edit) ---
function openQuickEdit(currentPlate) {
    document.getElementById("quickEditOverlay").style.display = "flex";
    const input = document.getElementById("quickEditInput");
    // Náº¿u biá»ƒn sá»‘ lÃ  'KhÃ´ng rÃµ' thÃ¬ Ä‘á»ƒ trá»‘ng Ä‘á»ƒ nháº­p cho nhanh
    input.value = (currentPlate && currentPlate !== 'æœªçŸ¥') ? currentPlate : "";
    input.focus();
}

function closeQuickEdit() {
    document.getElementById("quickEditOverlay").style.display = "none";
}

function submitQuickEdit() {
    const newPlate = document.getElementById("quickEditInput").value.trim().toUpperCase();
    if (!newPlate) return alert("è«‹è¼¸å…¥è»Šç‰Œï¼");
    
    if (!lastSessionId) return alert("æ‰¾ä¸åˆ°å¯ä¿®æ”¹çš„æœƒè©±ï¼");

    const formData = new FormData();
    formData.append("plate_number", newPlate);
    formData.append("status", "PARKING"); // Máº·c Ä‘á»‹nh lÃ  Ä‘ang gá»­i vÃ¬ Ä‘Ã¢y lÃ  sá»­a sau check-in
    formData.append("fee", "0");

    // Gá»i API PUT /api/sessions/{id}
    const apiUrl = BACKEND_URL.replace("/upload", `/api/sessions/${lastSessionId}`);

    fetch(apiUrl, { method: "PUT", body: formData })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            statusText.innerHTML = `âœ… å·²æ›´æ–°<br>ğŸš— è»Šç‰Œ: <b>${newPlate}</b>`;
            closeQuickEdit();
        } else {
            alert("Lá»—i: " + data.message);
        }
    })
    .catch(err => alert("é€£ç·šéŒ¯èª¤ï¼"));
}

// --- Logic Hiá»‡u á»©ng quÃ©t ---
function startScanEffect(status) {
    const overlay = document.getElementById("scanOverlay");
    const line = document.querySelector(".scan-line");
    // 1 = Check-in (Xanh lÃ¡), 0 = Check-out (Cam)
    const color = status === 1 ? "#00FF00" : "#FF9800";
    line.style.setProperty("--scan-color", color);
    overlay.style.display = "block";
}

function stopScanEffect() {
    document.getElementById("scanOverlay").style.display = "none";
}

</script>

</body>
</html>
