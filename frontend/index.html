<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Smart Parking - Scan Plate</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <style>
        body {
            margin: 0;
            background: black;
            color: white;
            font-family: Arial, sans-serif;
            text-align: center;
        }
        video {
            width: 100vw;
            height: 100vh;
            object-fit: cover;
        }
        #status {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            padding: 10px 20px;
            border-radius: 10px;
        }
        .actionBtn {
            position: fixed;
            bottom: 20px;
            padding: 12px 22px;
            font-size: 16px;
            border: none;
            border-radius: 10px;
            background-color: #00AAFF;
            color: white;
        }
        #checkinBtn { left: 30%; transform: translateX(-50%); }
        #checkoutBtn { left: 70%; transform: translateX(-50%); }
    </style>
</head>

<body>

<video id="video" autoplay playsinline></video>
<canvas id="canvas" style="display:none;"></canvas>

<div id="status">ƒêang kh·ªüi ƒë·ªông camera...</div>
<button id="checkinBtn" class="actionBtn">Check-in</button>
<button id="checkoutBtn" class="actionBtn">Check-out</button>

<script>
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const statusText = document.getElementById("status");
const checkinBtn = document.getElementById("checkinBtn");
const checkoutBtn = document.getElementById("checkoutBtn");

// üîß ƒê·ªäA CH·ªà BACKEND (s·ª≠a IP cho ƒë√∫ng)
// L∆∞u √Ω: Ph·∫£i d√πng https:// v√† ƒë√∫ng IP c·ªßa m√°y t√≠nh ch·∫°y backend
const BACKEND_URL = "https://192.168.43.82:8000/upload";

// 1Ô∏è‚É£ B·∫≠t camera sau
navigator.mediaDevices.getUserMedia({
    video: {
        facingMode: { ideal: "environment" }
    }
})
.then(stream => {
    video.srcObject = stream;
    statusText.innerText = "Camera ƒë√£ b·∫≠t ‚Äì b·∫•m 'Qu√©t' ƒë·ªÉ g·ª≠i ·∫£nh...";
})
.catch(err => {
    statusText.innerText = "Kh√¥ng b·∫≠t ƒë∆∞·ª£c camera!";
    console.error(err);
});

// 2Ô∏è‚É£ Khi b·∫•m n√∫t Check-in / Check-out ‚Äî g·ª≠i k√®m tr∆∞·ªùng `status` (1 = checkin, 0 = checkout)
async function sendCapture(status) {
    if (!video.videoWidth) {
        statusText.innerText = "Camera ch∆∞a s·∫µn s√†ng!";
        return;
    }

    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;

    const ctx = canvas.getContext("2d");
    ctx.drawImage(video, 0, 0);

    canvas.toBlob(blob => {
        const formData = new FormData();
        formData.append("image", blob, "plate.jpg");
        formData.append("status", String(status));

        statusText.innerText = "ƒêang g·ª≠i ·∫£nh...";

        fetch(BACKEND_URL, {
            method: "POST",
            body: formData
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                statusText.style.backgroundColor = "rgba(0, 0, 0, 0.7)"; // M√†u ƒëen (b√¨nh th∆∞·ªùng)
                if (status === 1) {
                    statusText.innerText = `‚úÖ ${data.message}\nüöó Bi·ªÉn s·ªë: ${data.plate_number || 'Kh√¥ng r√µ'}`;
                } else {
                    const feeStr = data.fee ? data.fee.toLocaleString('vi-VN') : "0";
                    statusText.innerText = `‚úÖ ${data.message}\nüöó Bi·ªÉn s·ªë: ${data.plate_number || 'Kh√¥ng r√µ'}\nüí∞ Ph√≠: ${feeStr} VNƒê`;
                }
            } else {
                statusText.style.backgroundColor = "rgba(255, 0, 0, 0.8)"; // M√†u ƒë·ªè (l·ªói/c·∫£nh b√°o)
                statusText.innerText = data.message || "‚ö†Ô∏è L·ªói t·ª´ Server";
            }
        })
        .catch(err => {
            statusText.innerText = "‚ùå Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c BE";
            console.error(err);
        });

    }, "image/jpeg", 0.8);
}

checkinBtn.addEventListener('click', () => sendCapture(1));
checkoutBtn.addEventListener('click', () => sendCapture(0));
</script>

</body>
</html>
